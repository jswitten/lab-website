{{ $item := .item }}
{{ $year_value := $item.Params.event_start | default $item.Date }}
{{ $year := (time $year_value).Format "2006" }}
{{ $has_attachments := partial "functions/has_attachments" $item }}

{{/* Get DOI if available */}}
{{ $doi := "" }}
{{ with $item.Params.hugoblox }}
  {{ with .ids }}
    {{ with .doi }}
      {{ $doi = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Check if under review */}}
{{ $under_review := $item.Params.under_review | default false }}

{{/* Check for featured/cover image */}}
{{ $featured_image := ($item.Resources.ByType "image").GetMatch "*featured*" }}

<div class="pub-list-item view-citation" style="margin-bottom: 1.5rem">
  {{/* Show cover image if exists */}}
  {{ with $featured_image }}
  <div style="margin-bottom: 0.5rem">
    {{ $img := .Fit "300x400" }}
    <img src="{{ $img.RelPermalink }}" alt="Cover image" style="max-width: 200px; border: 1px solid #ddd;">
  </div>
  {{ end }}
  <i class="far fa-file-alt pub-icon" aria-hidden="true"></i>

  {{/* Special format for under review papers: Authors. Journal, under review */}}
  {{ if $under_review }}
  <span class="article-metadata li-cite-author">
    {{ partial "page_metadata_authors" $item }}.
  </span>
  {{ if $item.Params.publication_short }}
    {{- $item.Params.publication_short | markdownify -}}
  {{ else if $item.Params.publication }}
    {{- $item.Params.publication | markdownify -}}
  {{ end }}

  {{/* APA Style */}}
  {{ else if eq (site.Params.hugoblox.content.citations.style | default "apa") "apa" }}

  <span class="article-metadata li-cite-author">
    {{ partial "page_metadata_authors" $item }}
  </span>
  ({{- $year -}}).
  {{ if $doi }}
    <a href="https://doi.org/{{ $doi }}" class="underline" target="_blank" rel="noopener">{{ $item.Title }}</a>.
  {{ else }}
    <span>{{ $item.Title }}</span>.
  {{ end }}
  {{ if $item.Params.publication_short }}
    {{- $item.Params.publication_short | markdownify -}}.
  {{ else if $item.Params.publication }}
    {{- $item.Params.publication | markdownify -}}.
  {{ end }}

  {{ if $has_attachments }}
  <div class="flex flex-wrap space-x-3">
    {{ partial "page_links" (dict "page" $item "is_list" 1) }}
  </div>
  {{ end }}

  {{/* MLA Style */}}
  {{ else }}

  <span class="article-metadata li-cite-author">
    {{ partial "page_metadata_authors" $item }}.
  </span>
  {{ if $doi }}
    <a href="https://doi.org/{{ $doi }}" target="_blank" rel="noopener">{{ $item.Title }}</a>.
  {{ else }}
    <span>{{ $item.Title }}</span>.
  {{ end }}
  {{ if $item.Params.publication_short }}
    {{- $item.Params.publication_short | markdownify -}},
  {{ else if $item.Params.publication }}
    {{- $item.Params.publication | markdownify -}},
  {{ end }}
  {{- $year -}}.

  {{ if $has_attachments }}
  <div class="flex flex-wrap space-x-3">
    {{ partial "page_links" (dict "page" $item "is_list" 1) }}
  </div>
  {{ end }}

  {{ end }}
</div>
